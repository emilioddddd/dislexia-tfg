<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <title>Perfil</title>
    <link rel="stylesheet" href="/styles/perfil.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <!-- Cabecera común -->
    <div id="cabecera-container"></div>

    <!-- Contenido principal -->
    <main id="contenidoPrincipal" style="display: none;">
        <h1 id="saludo">Cargando...</h1>

        <div class="bloque" id="datos-usuario">
            <h2>Datos del Usuario</h2>
            <p><strong>Usuario:</strong> <span id="username"></span></p>
            <p><strong>Email:</strong> <span id="email"></span></p>
            <p><strong>Rol:</strong> <span id="rol"></span></p>
        </div>

        <div class="bloque" id="bloqueProgreso">
            <h2>Progreso por Áreas</h2>
            <div class="grafico-container">
                <canvas id="graficoProgreso"></canvas>
            </div>
        </div>

        <div class="bloque" id="bloqueCitas">
            <h2>Proximas citas</h2>
            <ul id="listaCitas"></ul>
        </div>
    </main>

    <script>
        let rolUsuario = null;

        async function cargarCabeceraYPerfil() {
            try {
                const resCabecera = await fetch('/partials/cabecera.html');
                const htmlCabecera = await resCabecera.text();
                document.getElementById('cabecera-container').innerHTML = htmlCabecera;

                const resUsuario = await fetch('/api/usuarios/perfil', { credentials: 'include' });
                const data = await resUsuario.json();
                const user = data.usuario;

                if (!user) {
                    document.getElementById('saludo').textContent = "No autenticado";
                    return;
                }

                rolUsuario = user.rol;

                // Mostrar botón de panel si profesional
                if (rolUsuario === 'profesional') {
                    const btnPanel = document.getElementById('btnPanel');
                    if (btnPanel) btnPanel.style.display = 'inline-block';
                }

                // Saludo y datos
                document.getElementById('saludo').textContent = `Bienvenido, ${user.username}`;
                document.getElementById('username').textContent = user.username;
                document.getElementById('email').textContent = user.email;
                document.getElementById('rol').textContent = user.rol;

                // Mostrar contenido
                document.getElementById('contenidoPrincipal').style.display = 'block';

                if (rolUsuario === 'paciente') {
                    await cargarProgreso();
                } else {
                    document.getElementById('bloqueProgreso').style.display = 'none';
                }

                if (rolUsuario === 'profesional') {
                    const btnPanel = document.getElementById('btnPanel');
                    const linkProfesional = document.getElementById('linkProfesional');
                    if (btnPanel) btnPanel.style.display = 'inline-block';
                    if (linkProfesional) linkProfesional.style.display = 'inline-block';
                }


                await mostrarCitas();

                // Evento cerrar sesión
                const btnCerrar = document.getElementById('cerrarSesion');
                if (btnCerrar) {
                    btnCerrar.addEventListener('click', async () => {
                        await fetch('/api/usuarios/logout', {
                            method: 'POST',
                            credentials: 'include'
                        });
                        window.location.href = '/login.html';
                    });
                }

            } catch (err) {
                console.error('Error al cargar cabecera o perfil:', err);
                document.getElementById('saludo').textContent = 'Error al cargar el perfil.';
            }
        }

        async function cargarProgreso() {
            try {
                const res = await fetch('/api/resultados/progreso');
                const data = await res.json();
                const ctx = document.getElementById('graficoProgreso').getContext('2d');

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Velocidad', 'Precisión', 'Comprensión', 'Escritura'],
                        datasets: [{
                            label: 'Progreso (%)',
                            data: [data.velocidad, data.precision, data.comprension, data.escritura],
                            backgroundColor: [
                                'rgba(75, 192, 192, 0.7)',
                                'rgba(255, 159, 64, 0.7)',
                                'rgba(153, 102, 255, 0.7)',
                                'rgba(255, 99, 132, 0.7)'
                            ],
                            borderColor: [
                                'rgba(75, 192, 192, 1)',
                                'rgba(255, 159, 64, 1)',
                                'rgba(153, 102, 255, 1)',
                                'rgba(255, 99, 132, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error al cargar progreso:', error);
            }
        }

        async function mostrarCitas() {
            const endpoint = rolUsuario === 'profesional'
                ? '/api/citas/mis-citas'
                : '/api/citas/mis-citas-paciente';

            const res = await fetch(endpoint, { credentials: 'include' });
            const data = await res.json();
            const lista = document.getElementById('listaCitas');
            lista.innerHTML = '';

            if (res.ok && data.eventos) {
                const ahora = new Date();
                ahora.setHours(0, 0, 0, 0);

                const citasDesdeHoy = data.eventos
                    .filter(evt => {
                        const fecha = new Date(evt.start || evt.fecha);
                        return !isNaN(fecha) && fecha >= ahora;
                    })
                    .sort((a, b) => new Date(a.start || a.fecha) - new Date(b.start || b.fecha));

                if (citasDesdeHoy.length === 0) {
                    lista.innerHTML = '<li>No hay citas desde hoy.</li>';
                    return;
                }

                citasDesdeHoy.forEach(evt => {
                    const div = document.createElement('div');
                    div.innerHTML = `
            <h3>${new Date(evt.start || evt.fecha).toLocaleString()}</h3>
            <table>
              <thead>
                <tr>
                  ${rolUsuario === 'profesional' ? '<th>Paciente</th>' : ''}
                  <th>Juego</th>
                  ${rolUsuario === 'paciente' ? '<th>¿Jugado?</th>' : ''}
                </tr>
              </thead>
              <tbody>
                ${evt.juegos.map(j => `
                  <tr>
                    ${rolUsuario === 'profesional' ? `<td>${evt.title}</td>` : ''}
                    <td>${j.titulo}</td>
                    ${rolUsuario === 'paciente'
                            ? `<td><input type="checkbox" disabled ${j.jugado ? 'checked' : ''}></td>`
                            : ''}
                  </tr>`).join('')}
              </tbody>
            </table>
          `;
                    lista.appendChild(div);
                });
            }
        }

        cargarCabeceraYPerfil();
    </script>
</body>

</html>