<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Panel del Profesional</title>
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
</head>

<body>
    <h1 id="bienvenida">Cargando...</h1>
    <div id="contenidoProfesional" style="display: none;">
        <h2>Herramientas del profesional</h2>
        <ul>
            <li><a href="#">Ver lista de pacientes</a></li>
            <li><a href="#">Asignar actividades</a></li>
            <li><a href="#">Revisar progreso</a></li>
        </ul>

        <h2>Calendario de citas</h2>
        <div id="calendarioCitas"></div>

        <button id="abrirModalCita">Crear nueva cita</button>

        <!-- Modal para nueva cita -->
        <div id="modalCita" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%);
         background:white; padding:20px; border:1px solid black; z-index:1000;">
            <h3>Nueva cita</h3>
            <form id="formCita">
                <label>Paciente:
                    <select name="paciente" required id="selectPaciente"></select>
                </label><br>
                <label>Fecha y hora:
                    <input type="datetime-local" name="fecha" required>
                </label><br>
                <!--
        <label>Motivo:
          <input type="text" name="motivo" required>
        </label><br><br>
    -->
                <button type="submit">Guardar cita</button>
                <button type="button" id="cerrarModalCita">Cancelar</button>
            </form>
            <p id="mensajeCita"></p>
        </div>

        <h2>Mis pacientes</h2>
        <ul id="listaPacientes"></ul>

        <!-- Botón para abrir modal -->
        <button id="abrirModalRegistrarPaciente">Registrar nuevo paciente</button>
    </div>

    <!-- Modal para registrar paciente -->
    <div id="modalPaciente" style="display: none; position: fixed; top: 0; left: 0;
        width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 9999;">
        <div style="background: white; margin: 10% auto; padding: 20px; width: 300px; border-radius: 8px;">
            <h2>Registrar nuevo paciente</h2>
            <form id="formPaciente">
                <label>Email: <input type="email" name="email" required></label><br>
                <label>Nombre de usuario: <input type="text" name="username" required></label><br>
                <label>Contraseña: <input type="password" name="password" required></label><br>
                <label>DNI: <input type="text" name="dni" required></label><br>
                <label>Nombre completo: <input type="text" name="nombre" required></label><br><br>
                <button type="submit">Registrar</button>
                <button type="button" id="cerrarModal">Cancelar</button>
            </form>
            <p id="mensajePaciente" style="color: green;"></p>
        </div>
    </div>

    <button id="cerrarSesion">Cerrar sesión</button>

    <script>
        async function obtenerPacientes() {
            const res = await fetch('/api/usuarios/mis-pacientes', { credentials: 'include' });
            const data = await res.json();
            const lista = document.getElementById('listaPacientes');
            lista.innerHTML = '';

            if (res.ok) {
                data.pacientes.forEach(p => {
                    const li = document.createElement('li');
                    li.textContent = `${p.nombre} (DNI: ${p.dni})`;
                    lista.appendChild(li);
                });
            }
        }

        async function verificarSesion() {
            const res = await fetch('/api/usuarios/perfil', { credentials: 'include' });
            const data = await res.json();

            if (res.ok && data.usuario.rol === 'profesional') {
                document.getElementById('bienvenida').textContent = `Bienvenido, Dr. ${data.usuario.username}`;
                document.getElementById('contenidoProfesional').style.display = 'block';
                obtenerPacientes();
                cargarCalendario();
            } else {
                document.getElementById('bienvenida').textContent = 'Acceso denegado';
                document.getElementById('contenidoProfesional').style.display = 'none';
            }
        }

        async function cargarCalendario() {
            const res = await fetch('/api/citas/mis-citas', { credentials: 'include' });
            const data = await res.json();

            const calendarEl = document.getElementById('calendarioCitas');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'es',
                events: data.eventos || []
            });

            calendar.render();
        }

        document.getElementById('abrirModalRegistrarPaciente').addEventListener('click', () => {
            document.getElementById('modalPaciente').style.display = 'block';
        });

        document.getElementById('cerrarModal').addEventListener('click', () => {
            document.getElementById('modalPaciente').style.display = 'none';
            document.getElementById('formPaciente').reset();
            document.getElementById('mensajePaciente').textContent = '';
        });

        document.getElementById('formPaciente').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;

            const paciente = {
                email: form.email.value,
                username: form.username.value,
                password: form.password.value,
                dni: form.dni.value,
                nombre: form.nombre.value
            };

            const res = await fetch('/api/usuarios/registrar-paciente', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(paciente)
            });

            const data = await res.json();
            const mensaje = document.getElementById('mensajePaciente');

            if (res.ok) {
                mensaje.textContent = 'Paciente registrado correctamente.';
                form.reset();
                setTimeout(() => {
                    document.getElementById('modalPaciente').style.display = 'none';
                    mensaje.textContent = '';
                    obtenerPacientes();
                }, 1500);
            } else {
                mensaje.textContent = data.mensaje || 'Error al registrar paciente.';
                mensaje.style.color = 'red';
            }
        });

        // Modal de nueva cita
        document.getElementById('abrirModalCita').addEventListener('click', async () => {
            document.getElementById('modalCita').style.display = 'block';
            const res = await fetch('/api/usuarios/mis-pacientes', { credentials: 'include' });
            const data = await res.json();
            const select = document.getElementById('selectPaciente');
            select.innerHTML = '';

            if (res.ok) {
                data.pacientes.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p._id;
                    option.textContent = p.nombre;
                    select.appendChild(option);
                });
            }
        });

        document.getElementById('cerrarModalCita').addEventListener('click', () => {
            document.getElementById('modalCita').style.display = 'none';
            document.getElementById('formCita').reset();
            document.getElementById('mensajeCita').textContent = '';
        });

        document.getElementById('formCita').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;

            const cita = {
                paciente: form.paciente.value,
                fecha: form.fecha.value,
                //motivo: form.motivo.value
            };


            const res = await fetch('/api/citas/nueva', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(cita)
            });

            const data = await res.json();
            const mensaje = document.getElementById('mensajeCita');

            if (res.ok) {
                mensaje.textContent = 'Cita creada correctamente.';
                mensaje.style.color = 'green';
                form.reset();

                setTimeout(() => {
                    document.getElementById('modalCita').style.display = 'none';
                    mensaje.textContent = '';
                    cargarCalendario();
                }, 1500);
            } else {
                mensaje.textContent = data.mensaje || 'Error al crear cita.';
                mensaje.style.color = 'red';
            }
        });

        document.getElementById('cerrarSesion').addEventListener('click', async () => {
            await fetch('/api/usuarios/logout', {
                method: 'POST',
                credentials: 'include'
            });
            window.location.href = '/login.html';
        });

        verificarSesion();
    </script>
</body>

</html>