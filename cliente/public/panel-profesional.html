<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Panel del Profesional</title>
</head>

<body>
    <h1 id="bienvenida">Cargando...</h1>
    <div id="contenidoProfesional" style="display: none;">
        <h2>Herramientas del profesional</h2>
        <ul>
            <li><a href="#">Ver lista de pacientes</a></li>
            <li><a href="#">Asignar actividades</a></li>
            <li><a href="#">Revisar progreso</a></li>
        </ul>

        <h2>Mis pacientes</h2>
        <ul id="listaPacientes"></ul>

        <h2>Registrar nuevo paciente</h2>
        <form id="formPaciente">
            <label>Email: <input type="email" name="email" required></label><br>
            <label>Nombre de usuario: <input type="text" name="username" required></label><br>
            <label>Contraseña: <input type="password" name="password" required></label><br>
            <label>DNI: <input type="text" name="dni" required></label><br>
            <label>Nombre completo: <input type="text" name="nombre" required></label><br>
            <button type="submit">Registrar paciente</button>
        </form>

        <p id="mensajePaciente"></p>
    </div>

    <button id="cerrarSesion">Cerrar sesión</button>

    <script>
        async function obtenerPacientes() {
            const res = await fetch('/api/usuarios/mis-pacientes', {
                credentials: 'include'
            });

            const data = await res.json();
            const lista = document.getElementById('listaPacientes');
            lista.innerHTML = ''; // Limpiar antes de recargar

            if (res.ok) {
                data.pacientes.forEach(p => {
                    const li = document.createElement('li');
                    li.textContent = `${p.nombre} (DNI: ${p.dni})`;
                    lista.appendChild(li);
                });
            } else {
                console.log(data.mensaje);
            }
        }

        async function verificarSesion() {
            const res = await fetch('/api/usuarios/perfil', {
                credentials: 'include'
            });

            const data = await res.json();

            if (res.ok && data.usuario.rol === 'profesional') {
                document.getElementById('bienvenida').textContent = `Bienvenido, Dr. ${data.usuario.username}`;
                document.getElementById('contenidoProfesional').style.display = 'block';
                obtenerPacientes();
            } else {
                document.getElementById('bienvenida').textContent = 'Acceso denegado';
                document.getElementById('contenidoProfesional').style.display = 'none';
            }
        }

        document.getElementById('formPaciente').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;

            const paciente = {
                email: form.email.value,
                username: form.username.value,
                password: form.password.value,
                dni: form.dni.value,
                nombre: form.nombre.value
            };

            const res = await fetch('/api/usuarios/registrar-paciente', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(paciente)
            });

            const data = await res.json();
            document.getElementById('mensajePaciente').textContent = data.mensaje;

            if (res.ok) {
                form.reset();
                obtenerPacientes();
            }
        });

        document.getElementById('cerrarSesion').addEventListener('click', async () => {
            await fetch('/api/usuarios/logout', {
                method: 'POST',
                credentials: 'include'
            });
            window.location.href = '/login.html';
        });

        verificarSesion();
    </script>
</body>

</html>
