<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Panel del Profesional</title>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
</head>

<body>
    <h1 id="bienvenida">Cargando...</h1>

    <div id="contenidoProfesional" style="display: none;">
        <h2>Herramientas del profesional</h2>
        <ul>
            <li><a href="#">Ver lista de pacientes</a></li>
            <li><a href="#">Asignar actividades</a></li>
            <li><a href="#">Revisar progreso</a></li>
            <li><a href="/juegos.html"><button>Ver juegos</button></a></li>
        </ul>

        <h2>Calendario de citas</h2>
        <div id="calendarioCitas"></div>

        <button id="abrirModalCita">Crear nueva cita</button>

        <!-- Modal de creación de cita -->
        <div id="modalCita"
            style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:white; padding:20px; border:1px solid black; z-index:1000;">
            <h3>Nueva cita</h3>
            <form id="formCita">
                <label>Paciente:
                    <select name="paciente" required id="selectPaciente"></select>
                </label><br>
                <label>Fecha:
                    <input type="date" name="fechaDia" id="fechaDia" required>
                </label><br>
                <label>Hora:
                    <select name="hora" id="horaDisponible" required></select>
                </label><br>
                <button type="submit">Guardar cita</button>
                <button type="button" id="cerrarModalCita">Cancelar</button>
            </form>
            <p id="mensajeCita"></p>
        </div>

        <h2>Mis pacientes</h2>
        <ul id="listaPacientes"></ul>
        <button id="abrirModalRegistrarPaciente">Registrar nuevo paciente</button>
    </div>

    <!-- Modal de nuevo paciente -->
    <div id="modalPaciente"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:9999;">
        <div style="background:white; margin:10% auto; padding:20px; width:300px; border-radius:8px;">
            <h2>Registrar nuevo paciente</h2>
            <form id="formPaciente">
                <label>Email: <input type="email" name="email" required></label><br>
                <label>Usuario: <input type="text" name="username" required></label><br>
                <label>Contraseña: <input type="password" name="password" required></label><br>
                <label>DNI: <input type="text" name="dni" required></label><br>
                <label>Nombre completo: <input type="text" name="nombre" required></label><br><br>
                <button type="submit">Registrar</button>
                <button type="button" id="cerrarModal">Cancelar</button>
            </form>
            <p id="mensajePaciente" style="color: green;"></p>
        </div>
    </div>

    <button id="cerrarSesion">Cerrar sesión</button>

    <script>
        async function verificarSesion() {
            const res = await fetch('/api/usuarios/perfil', { credentials: 'include' });
            const data = await res.json();

            if (res.ok && data.usuario.rol === 'profesional') {
                document.getElementById('bienvenida').textContent = `Bienvenido, Dr. ${data.usuario.username}`;
                document.getElementById('contenidoProfesional').style.display = 'block';
                obtenerPacientes();
                cargarCalendario();
            } else {
                document.getElementById('bienvenida').textContent = 'Acceso denegado';
            }
        }

        async function obtenerPacientes() {
            const res = await fetch('/api/usuarios/mis-pacientes', { credentials: 'include' });
            const data = await res.json();
            const lista = document.getElementById('listaPacientes');
            lista.innerHTML = '';
            if (res.ok) {
                data.pacientes.forEach(p => {
                    const li = document.createElement('li');
                    li.textContent = `${p.nombre} (DNI: ${p.dni})`;
                    lista.appendChild(li);
                });
            }
        }

        async function cargarCalendario() {
            const res = await fetch('/api/citas/mis-citas', { credentials: 'include' });
            const data = await res.json();
            const calendarEl = document.getElementById('calendarioCitas');
            calendarEl.innerHTML = '';
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'es',
                events: data.eventos || [],
                dateClick: function (info) {
                    const fecha = info.dateStr;
                    window.open(`/ver-citas-dia.html?fecha=${fecha}`, '_blank');
                }
            });
            calendar.render();
        }

        // Abrir modal nueva cita
        document.getElementById('abrirModalCita').addEventListener('click', async () => {
            document.getElementById('modalCita').style.display = 'block';

            const res = await fetch('/api/usuarios/mis-pacientes', { credentials: 'include' });
            const data = await res.json();
            const select = document.getElementById('selectPaciente');
            select.innerHTML = '';
            if (res.ok) {
                data.pacientes.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p._id;
                    option.textContent = p.nombre;
                    select.appendChild(option);
                });
            }

            // Evita fechas pasadas
            const hoy = new Date().toISOString().split('T')[0];
            const fechaInput = document.getElementById('fechaDia');
            fechaInput.min = hoy;
            fechaInput.value = hoy;
            fechaInput.dispatchEvent(new Event('change'));
        });


        // Cerrar modal cita
        document.getElementById('cerrarModalCita').addEventListener('click', () => {
            document.getElementById('modalCita').style.display = 'none';
            document.getElementById('formCita').reset();
            document.getElementById('mensajeCita').textContent = '';
        });

        // Cambiar fecha para cargar horas disponibles
        document.getElementById('fechaDia').addEventListener('change', async (e) => {
            const fecha = e.target.value;
            const horaSelect = document.getElementById('horaDisponible');
            if (!fecha) return;

            const res = await fetch(`/api/citas/horarios-dia?fecha=${fecha}`, { credentials: 'include' });
            const data = await res.json();
            horaSelect.innerHTML = '';

            if (res.ok && data.horarios.length > 0) {
                data.horarios.forEach(horario => {
                    if (!horario.paciente) {
                        const option = document.createElement('option');
                        option.value = horario.hora;
                        option.textContent = horario.hora;
                        horaSelect.appendChild(option);
                    }
                });
            } else {
                const option = document.createElement('option');
                option.disabled = true;
                option.textContent = 'No hay horas disponibles';
                horaSelect.appendChild(option);
            }
        });

        // Crear cita
        document.getElementById('formCita').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const fechaCompleta = `${form.fechaDia.value}T${form.hora.value}`;
            const cita = {
                paciente: form.paciente.value,
                fecha: fechaCompleta
            };

            const res = await fetch('/api/citas/nueva', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(cita)
            });

            const data = await res.json();
            const mensaje = document.getElementById('mensajeCita');
            if (res.ok) {
                mensaje.textContent = 'Cita creada correctamente.';
                mensaje.style.color = 'green';
                form.reset();
                setTimeout(() => {
                    document.getElementById('modalCita').style.display = 'none';
                    mensaje.textContent = '';
                    cargarCalendario();
                }, 1500);
            } else {
                mensaje.textContent = data.mensaje || 'Error al crear cita.';
                mensaje.style.color = 'red';
            }
        });

        // Modal paciente
        document.getElementById('abrirModalRegistrarPaciente').addEventListener('click', () => {
            document.getElementById('modalPaciente').style.display = 'block';
        });

        document.getElementById('cerrarModal').addEventListener('click', () => {
            document.getElementById('modalPaciente').style.display = 'none';
            document.getElementById('formPaciente').reset();
            document.getElementById('mensajePaciente').textContent = '';
        });

        document.getElementById('formPaciente').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const paciente = {
                email: form.email.value,
                username: form.username.value,
                password: form.password.value,
                dni: form.dni.value,
                nombre: form.nombre.value
            };
            const res = await fetch('/api/usuarios/registrar-paciente', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(paciente)
            });
            const data = await res.json();
            const mensaje = document.getElementById('mensajePaciente');
            if (res.ok) {
                mensaje.textContent = 'Paciente registrado correctamente.';
                form.reset();
                setTimeout(() => {
                    document.getElementById('modalPaciente').style.display = 'none';
                    mensaje.textContent = '';
                    obtenerPacientes();
                }, 1500);
            } else {
                mensaje.textContent = data.mensaje || 'Error al registrar paciente.';
                mensaje.style.color = 'red';
            }
        });

        document.getElementById('cerrarSesion').addEventListener('click', async () => {
            await fetch('/api/usuarios/logout', {
                method: 'POST',
                credentials: 'include'
            });
            window.location.href = '/login.html';
        });

        verificarSesion();
    </script>
</body>

</html>